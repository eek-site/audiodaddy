<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Successful | Audio Daddy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="manifest" href="/site.webmanifest">
  <style>
    :root {
      --color-bg: #0a0a0b;
      --color-surface: #141416;
      --color-surface-2: #1c1c1f;
      --color-text: #ffffff;
      --color-text-muted: #8a8a8d;
      --color-accent: #00d4aa;
      --color-accent-hover: #00f5c4;
      --color-border: #2a2a2d;
      --color-success: #00d4aa;
      --color-danger: #ff6b6b;
      --font-display: 'Outfit', system-ui, sans-serif;
      --font-mono: 'Space Mono', monospace;
      --radius: 12px;
      --radius-lg: 20px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-display);
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 48px;
      max-width: 600px;
      width: 100%;
    }

    .icon {
      font-size: 4rem;
      margin-bottom: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 16px;
      color: var(--color-accent);
      text-align: center;
    }

    p {
      color: var(--color-text-muted);
      line-height: 1.7;
      margin-bottom: 24px;
      text-align: center;
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius);
      padding: 48px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(0, 212, 170, 0.02);
      margin-bottom: 24px;
      text-align: center;
    }

    .upload-zone:hover,
    .upload-zone.drag-over {
      border-color: var(--color-accent);
      background: rgba(0, 212, 170, 0.05);
    }

    .upload-zone.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .upload-zone h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .upload-zone span {
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }

    .upload-zone input {
      display: none;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .supported-formats {
      margin-top: 16px;
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }

    .format-tag {
      display: inline-block;
      background: var(--color-surface-2);
      padding: 4px 10px;
      border-radius: 6px;
      margin: 3px;
      font-family: var(--font-mono);
    }

    /* File Info */
    .file-info {
      background: var(--color-surface-2);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
      display: none;
      border-left: 4px solid var(--color-accent);
    }

    .file-info.visible {
      display: flex;
      align-items: center;
      gap: 16px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .file-icon {
      font-size: 2rem;
    }

    .file-meta {
      flex: 1;
      text-align: left;
    }

    .file-name {
      font-weight: 600;
      font-size: 0.95rem;
      word-break: break-all;
    }

    .file-size {
      color: var(--color-text-muted);
      font-size: 0.85rem;
      font-family: var(--font-mono);
    }

    .remove-file-btn {
      background: rgba(255, 107, 107, 0.2);
      color: var(--color-danger);
      border: 1px solid rgba(255, 107, 107, 0.3);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .remove-file-btn:hover {
      background: rgba(255, 107, 107, 0.3);
    }

    /* Transcribe Button */
    .transcribe-btn {
      width: 100%;
      padding: 18px 28px;
      background: linear-gradient(135deg, var(--color-accent), #00a080);
      color: var(--color-bg);
      border: none;
      border-radius: var(--radius);
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .transcribe-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 212, 170, 0.3);
    }

    .transcribe-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .transcribe-btn .spinner {
      display: none;
      width: 22px;
      height: 22px;
      border: 3px solid rgba(0, 0, 0, 0.2);
      border-top-color: var(--color-bg);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .transcribe-btn.loading .spinner {
      display: block;
    }

    .transcribe-btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress */
    .progress-section {
      display: none;
      margin-bottom: 24px;
    }

    .progress-section.visible {
      display: block;
    }

    .progress-bar-container {
      background: var(--color-surface-2);
      border-radius: 10px;
      overflow: hidden;
      height: 10px;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-accent), var(--color-accent-hover));
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }

    /* Result Section */
    .result-section {
      display: none;
    }

    .result-section.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .result-header h3 {
      color: var(--color-accent);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-actions {
      display: flex;
      gap: 10px;
    }

    .result-btn {
      padding: 10px 18px;
      background: var(--color-surface-2);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .result-btn:hover {
      background: var(--color-border);
      transform: translateY(-2px);
    }

    .transcript-box {
      background: var(--color-surface-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 24px;
      max-height: 350px;
      overflow-y: auto;
      margin-bottom: 24px;
    }

    .transcript-text {
      font-size: 1rem;
      line-height: 1.9;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
    }

    /* Error */
    .error-box {
      display: none;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-bottom: 24px;
    }

    .error-box.visible {
      display: block;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    .error-box h4 {
      color: var(--color-danger);
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .error-box p {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      margin: 0;
      text-align: left;
    }

    /* Verifying State */
    .verifying-state {
      text-align: center;
      padding: 40px 0;
    }

    .verifying-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    /* Links */
    .back-link {
      display: inline-block;
      margin-top: 16px;
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 500;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .new-transcription {
      text-align: center;
      margin-top: 16px;
    }

    .new-transcription a {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 500;
    }

    .new-transcription a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .card {
        padding: 32px 24px;
      }
      
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .result-actions {
        width: 100%;
      }
      
      .result-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Verifying State -->
    <div id="verifyingState" class="verifying-state">
      <div class="verifying-spinner"></div>
      <h1>Verifying payment...</h1>
      <p>Please wait while we confirm your payment.</p>
    </div>

    <!-- Upload State (shown after verification) -->
    <div id="uploadState" style="display: none;">
      <div class="icon">‚úÖ</div>
      <h1>Payment confirmed!</h1>
      <p>Upload your audio file to get your transcript.</p>
      
      <div class="error-box" id="errorBox">
        <h4>‚ö†Ô∏è Error</h4>
        <p id="errorText"></p>
      </div>

      <!-- File Info -->
      <div class="file-info" id="fileInfo">
        <span class="file-icon">üéß</span>
        <div class="file-meta">
          <div class="file-name" id="fileName"></div>
          <div class="file-size" id="fileSize"></div>
        </div>
        <button class="remove-file-btn" onclick="removeFile()">Remove</button>
      </div>

      <!-- Upload Zone -->
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">üéµ</div>
        <h3>Drop your audio file here</h3>
        <span>or click to browse</span>
        <input type="file" id="fileInput" accept="audio/*,.mp3,.mp4,.mpeg,.mpga,.m4a,.wav,.webm" />
        <div class="supported-formats">
          <span class="format-tag">MP3</span>
          <span class="format-tag">M4A</span>
          <span class="format-tag">WAV</span>
          <span class="format-tag">MP4</span>
          <span class="format-tag">WEBM</span>
        </div>
      </div>

      <!-- Transcribe Button -->
      <button class="transcribe-btn" id="transcribeBtn" onclick="transcribe()" disabled>
        <span class="spinner"></span>
        <span class="btn-text">üöÄ Transcribe Audio</span>
      </button>

      <!-- Progress Section -->
      <div class="progress-section" id="progressSection">
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text" id="progressText">Processing...</p>
      </div>

      <!-- Result Section -->
      <div class="result-section" id="resultSection">
        <div class="result-header">
          <h3>‚úì Transcription complete</h3>
          <div class="result-actions">
            <button class="result-btn" onclick="copyToClipboard()">üìã Copy</button>
            <button class="result-btn" onclick="downloadTranscript()">üíæ Download</button>
          </div>
        </div>
        <div class="transcript-box">
          <div class="transcript-text" id="transcriptText"></div>
        </div>
        <div class="new-transcription">
          <a href="/">‚Üê Transcribe another file</a>
        </div>
      </div>

      <a href="/" class="back-link">‚Üê Back to home</a>
    </div>

    <!-- Error State (if verification fails) -->
    <div id="errorState" style="display: none;">
      <div class="icon">‚ùå</div>
      <h1>Payment verification failed</h1>
      <p id="verifyErrorText">We couldn't verify your payment. Please contact support if you believe this is an error.</p>
      <a href="/" class="back-link">‚Üê Back to home</a>
    </div>
  </div>

  <script>
    // ===========================================
    // CONFIGURATION
    // ===========================================
    const CONFIG = {
      // Power Automate endpoint to verify payment and get API key
      verifyPaymentEndpoint: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/10456dc3f0314fe3a7476c3352e9d691/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mdHcU5A73pMcBCrSxaYDPw1Zbae7j0JaOCRy8zN7bpI',
      maxFileSize: 25 * 1024 * 1024 // 25MB
    };

    // ===========================================
    // STATE
    // ===========================================
    let state = {
      sessionId: null,
      apiKey: null,
      isVerified: false,
      selectedFile: null,
      transcript: ''
    };

    // ===========================================
    // DOM ELEMENTS
    // ===========================================
    const elements = {
      verifyingState: document.getElementById('verifyingState'),
      uploadState: document.getElementById('uploadState'),
      errorState: document.getElementById('errorState'),
      uploadZone: document.getElementById('uploadZone'),
      fileInput: document.getElementById('fileInput'),
      fileInfo: document.getElementById('fileInfo'),
      fileName: document.getElementById('fileName'),
      fileSize: document.getElementById('fileSize'),
      transcribeBtn: document.getElementById('transcribeBtn'),
      progressSection: document.getElementById('progressSection'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText'),
      resultSection: document.getElementById('resultSection'),
      transcriptText: document.getElementById('transcriptText'),
      errorBox: document.getElementById('errorBox'),
      errorText: document.getElementById('errorText'),
      verifyErrorText: document.getElementById('verifyErrorText')
    };

    // ===========================================
    // INITIALIZATION
    // ===========================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Get session ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      state.sessionId = urlParams.get('session_id');

      if (!state.sessionId) {
        showErrorState('No payment session found. Please start a new transcription.');
        return;
      }

      // Verify payment and get API key
      await verifyPayment();

      // Set up upload handlers
      setupUploadHandlers();
    });

    // ===========================================
    // PAYMENT VERIFICATION
    // ===========================================
    async function verifyPayment() {
      try {
        const response = await fetch(CONFIG.verifyPaymentEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: state.sessionId })
        });

        const data = await response.json();

        if (response.ok && data.valid && data.key) {
          // Payment verified - store API key and show upload
          state.apiKey = data.key;
          state.isVerified = true;
          showUploadState();
        } else {
          showErrorState(data.message || 'Payment could not be verified.');
        }
      } catch (error) {
        console.error('Verification error:', error);
        showErrorState('Connection error. Please try again or contact support.');
      }
    }

    function showUploadState() {
      elements.verifyingState.style.display = 'none';
      elements.errorState.style.display = 'none';
      elements.uploadState.style.display = 'block';
    }

    function showErrorState(message) {
      elements.verifyingState.style.display = 'none';
      elements.uploadState.style.display = 'none';
      elements.verifyErrorText.textContent = message;
      elements.errorState.style.display = 'block';
    }

    // ===========================================
    // FILE UPLOAD
    // ===========================================
    function setupUploadHandlers() {
      // Click to upload
      elements.uploadZone.addEventListener('click', () => {
        elements.fileInput.click();
      });

      // File input change
      elements.fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      // Drag and drop
      elements.uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.uploadZone.classList.add('drag-over');
      });

      elements.uploadZone.addEventListener('dragleave', () => {
        elements.uploadZone.classList.remove('drag-over');
      });

      elements.uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      hideError();

      // Validate file type
      const validExtensions = ['.mp3', '.mp4', '.mpeg', '.mpga', '.m4a', '.wav', '.webm'];
      const hasValidExtension = validExtensions.some(ext => 
        file.name.toLowerCase().endsWith(ext)
      );
      
      if (!hasValidExtension && !file.type.startsWith('audio/')) {
        showError('Please select a valid audio file (MP3, M4A, WAV, MP4, or WEBM)');
        return;
      }

      // Validate file size
      if (file.size > CONFIG.maxFileSize) {
        showError('File size exceeds 25MB limit. Please use a smaller file.');
        return;
      }

      state.selectedFile = file;
      elements.fileName.textContent = file.name;
      elements.fileSize.textContent = formatFileSize(file.size);
      elements.fileInfo.classList.add('visible');
      elements.uploadZone.style.display = 'none';
      updateTranscribeButton();
    }

    function removeFile() {
      state.selectedFile = null;
      elements.fileInput.value = '';
      elements.fileInfo.classList.remove('visible');
      elements.uploadZone.style.display = 'block';
      elements.resultSection.classList.remove('visible');
      updateTranscribeButton();
    }

    function updateTranscribeButton() {
      elements.transcribeBtn.disabled = !state.isVerified || !state.selectedFile;
    }

    // ===========================================
    // TRANSCRIPTION (Direct to OpenAI)
    // ===========================================
    async function transcribe() {
      if (!state.isVerified || !state.apiKey) {
        showError('Payment not verified. Please refresh and try again.');
        return;
      }

      if (!state.selectedFile) {
        showError('Please select an audio file');
        return;
      }

      // Update UI
      elements.transcribeBtn.classList.add('loading');
      elements.transcribeBtn.disabled = true;
      elements.progressSection.classList.add('visible');
      elements.resultSection.classList.remove('visible');
      hideError();

      // Simulate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        elements.progressBar.style.width = progress + '%';

        if (progress < 30) {
          elements.progressText.textContent = 'Uploading audio file...';
        } else if (progress < 60) {
          elements.progressText.textContent = 'Processing with Whisper...';
        } else {
          elements.progressText.textContent = 'Generating transcript...';
        }
      }, 500);

      try {
        // Call OpenAI Whisper API directly
        const formData = new FormData();
        formData.append('file', state.selectedFile);
        formData.append('model', 'whisper-1');
        formData.append('response_format', 'text');

        const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.apiKey}`
          },
          body: formData
        });

        clearInterval(progressInterval);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `API Error: ${response.status}`);
        }

        const transcript = await response.text();

        // Complete progress
        elements.progressBar.style.width = '100%';
        elements.progressText.textContent = 'Complete!';

        // Show result
        setTimeout(() => {
          elements.progressSection.classList.remove('visible');
          state.transcript = transcript;
          elements.transcriptText.textContent = transcript;
          elements.resultSection.classList.add('visible');
        }, 500);

      } catch (error) {
        clearInterval(progressInterval);
        elements.progressSection.classList.remove('visible');

        let errorMsg = error.message;
        if (errorMsg.includes('401')) {
          errorMsg = 'API key authentication failed. Please contact support.';
        } else if (errorMsg.includes('429')) {
          errorMsg = 'Rate limit exceeded. Please wait a moment and try again.';
        } else if (errorMsg.includes('insufficient_quota')) {
          errorMsg = 'API quota exceeded. Please contact support.';
        }

        showError(errorMsg);
      } finally {
        elements.transcribeBtn.classList.remove('loading');
        updateTranscribeButton();
      }
    }

    // ===========================================
    // RESULT ACTIONS
    // ===========================================
    function copyToClipboard() {
      navigator.clipboard.writeText(state.transcript).then(() => {
        const btn = event.target.closest('.result-btn');
        const original = btn.innerHTML;
        btn.innerHTML = '‚úì Copied!';
        setTimeout(() => { btn.innerHTML = original; }, 2000);
      }).catch(() => {
        showError('Failed to copy to clipboard');
      });
    }

    function downloadTranscript() {
      const blob = new Blob([state.transcript], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (state.selectedFile?.name?.replace(/\.[^/.]+$/, '') || 'transcript') + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ===========================================
    // ERROR HANDLING
    // ===========================================
    function showError(message) {
      elements.errorText.textContent = message;
      elements.errorBox.classList.add('visible');
    }

    function hideError() {
      elements.errorBox.classList.remove('visible');
    }

    // ===========================================
    // UTILITIES
    // ===========================================
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
  </script>
</body>
</html>
